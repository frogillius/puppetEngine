<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Puppet</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; }
        #container { position: relative; width: 100%; height: 100%; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
    </div>
    <script>
        const SCALE = 1.0; // Change scale factor here
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        const JSON_URL = getQueryParam("config") || "http://localhost:6969/fallback.json"; // Get config from URL or use fallback
        const CANVAS_WIDTH = parseInt(getQueryParam("width")) || container.clientWidth;
        const CANVAS_HEIGHT = parseInt(getQueryParam("height")) || container.clientHeight;

        const container = document.getElementById("container");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        function resizeCanvas() {
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        async function loadJSON(url) {
            const response = await fetch(url);
            return response.json();
        }

        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = src;
                img.onload = () => resolve(img);
                img.onerror = reject;
            });
        }

        async function loadPuppet() {
            const data = await loadJSON(JSON_URL);
            const root = data.encounter.portrait.puppet.bodyParts.root;
            await renderPart(root, canvas.width / 2, canvas.height / 2, 0);
        }

        async function renderPart(part, x, y, parentRotation) {
            const img = await loadImage(part.image);
            const params = await loadJSON(part.params);
            
            const { xOffset = 0, yOffset = 0, rotation = 0 } = params;
            const newRotation = parentRotation + rotation;
            const newX = x + xOffset * SCALE;
            const newY = y + yOffset * SCALE;
            
            ctx.save();
            ctx.translate(newX, newY);
            ctx.rotate(newRotation * Math.PI / 180);
            ctx.drawImage(img, -img.width / 2 * SCALE, -img.height / 2 * SCALE, img.width * SCALE, img.height * SCALE);
            ctx.restore();
            
            if (part.children) {
                for (const childKey in part.children) {
                    await renderPart(part.children[childKey], newX, newY, newRotation);
                }
            }
        }

        loadPuppet();
    </script>
</body>
</html>
