<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Puppet Render</title>
  <style>
    body { margin: 0; background: transparent; }
    #puppetContainer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .part { position: absolute; }
  </style>
</head>
<body>
  <div id="puppetContainer"></div>

  <script>
    function loadPuppet(configUrl) {
      fetch(configUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
          }
          return response.json();
        })
        .then(config => {
          console.log(config); // Log the entire config object
          const root = document.getElementById('puppetContainer');
          function buildPart(name, partConfig, parentElem) {
            fetch(partConfig.params)
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return response.json();
              })
              .then(params => {
                const part = document.createElement('img');
                part.src = partConfig.image;
                part.classList.add('part');
                part.style.transform = `translate(${params.position.x}px, ${params.position.y}px) rotate(${params.rotation}deg)`;
                part.style.transformOrigin = params.transformOrigin;
                parentElem.appendChild(part);

                if (partConfig.children) {
                  for (let childName in partConfig.children) {
                    buildPart(childName, partConfig.children[childName], part);
                  }
                }
              })
              .catch(error => {
                console.error(`Failed to load part params: ${error}`);
                const part = document.createElement('img');
                part.src = `http://localhost:6969/assets/crap/crap.png`;
                part.classList.add('part');
                part.style.transform = `translate(0px, 0px) rotate(0deg)`;
                part.style.transformOrigin = '50% 50%';
                parentElem.appendChild(part);
              });
          }
          console.log(config.encounter.portrait.puppet.bodyParts.root);
          buildPart("root", config.encounter.portrait.puppet.bodyParts.root, root);
        })
        .catch(error => {
          console.error(`Failed to load config: ${error}`);
          const root = document.getElementById('puppetContainer');
          const part = document.createElement('img');
          part.src = `http://localhost:6969/assets/crap/crap.png`;
          part.classList.add('part');
          part.style.transform = `translate(0px, 0px) rotate(0deg)`;
          part.style.transformOrigin = '50% 50%';
          root.appendChild(part);
        });
    }

    // Get the config URL from query params (allows custom configs)
    const params = new URLSearchParams(window.location.search);
    const configUrl = params.get("config") || "fallback.json";
    loadPuppet(configUrl);
  </script>
</body>
</html>
